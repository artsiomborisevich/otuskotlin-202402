name: ü§ñ Copilot Auto-Executor

on:
  issues:
    types: [opened, assigned]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  execute-copilot-fix:
    # Only run when Copilot is assigned to an issue with the security fix title
    if: |
      github.event.issue.title == 'üö® Automated Security Fixes Required (HIGH/CRITICAL)' &&
      contains(github.event.issue.assignees.*.login, 'copilot-swe-agent')
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Setup Java and Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: üîí Grant Execute Permission to gradlew
        run: chmod +x ./gradlew

      - name: üìù Add Comment to Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ü§ñ **Copilot Auto-Executor Started**\n\nI am now processing this issue automatically. Will create a PR with fixes shortly...'
            });

      - name: üîç Extract Dependency Info from Issue
        id: parse_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = context.payload.issue.body;
            // Extract package names and versions from the issue body
            core.setOutput('has_fixes', 'true');
            return true;

      - name: üöÄ Execute Automated Fixes
        id: fix
        run: |
          # Create a new branch
          BRANCH_NAME="copilot-autofix-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Branch created: $BRANCH_NAME"

      - name: üîß Apply Dependency Updates
        run: |
          # This is where you'd parse the issue and apply fixes
          # For now, we'll update to latest Spring Boot as example
          
          # Read current build.gradle
          if [ -f "build.gradle" ]; then
            echo "Found build.gradle, analyzing..."
            
            # Example: Update Spring Boot version (you can expand this)
            # sed -i "s/spring-boot-starter-test'/spring-boot-starter-test'/" build.gradle
            
            echo "Dependencies analyzed. Manual fixes may be needed."
          fi

      - name: üß™ Run Tests
        id: test
        continue-on-error: true
        run: |
          ./gradlew clean build
          echo "BUILD_STATUS=$?" >> $GITHUB_ENV

      - name: üíæ Commit Changes
        id: commit
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "fix: Update HIGH/CRITICAL dependencies and fix deprecated methods
            
            Automated fixes for security vulnerabilities.
            Related to issue #${{ github.event.issue.number }}"
            git push origin $BRANCH_NAME
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            echo "No changes detected"
          fi

      - name: üéØ Create Pull Request
        if: env.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ü§ñ Automated Security Fixes (HIGH/CRITICAL)',
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## üõ°Ô∏è Automated Security Fixes
            
            This PR was automatically created to fix HIGH and CRITICAL severity vulnerabilities.
            
            ### Related Issue
            Closes #${{ github.event.issue.number }}
            
            ### Changes Made
            - Updated vulnerable dependencies
            - Fixed deprecated method usages
            - Verified build passes
            
            ### Build Status
            ${process.env.BUILD_STATUS === '0' ? '‚úÖ Build Successful' : '‚ö†Ô∏è Build may need attention'}
            
            Please review the changes before merging.`
            });
            
            // Comment on the original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Pull Request Created**: #${pr.data.number}\n\nPlease review and merge: ${pr.data.html_url}`
            });

      - name: ‚ö†Ô∏è Report Failure
        if: env.HAS_CHANGES == 'false' || failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå **Automated fix failed or no changes detected**\n\nManual intervention may be required. Please review the workflow logs for details.'
            });

