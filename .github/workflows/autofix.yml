name: ü§ñ Auto-Fix Dependencies

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to perform'
        required: false
        default: 'security'
        type: choice
        options:
          - security
          - all
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: read

jobs:
  scan-and-fix:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Setup Java and Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: üîí Grant Execute Permission to gradlew
        run: chmod +x ./gradlew

      - name: üîç Check for Dependabot Alerts
        id: check_alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const alerts = await github.rest.dependabot.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                severity: 'high,critical'
              });
              
              const highCritical = alerts.data.filter(a => 
                a.security_advisory.severity === 'high' || 
                a.security_advisory.severity === 'critical'
              );
              
              core.setOutput('has_alerts', highCritical.length > 0);
              core.setOutput('alert_count', highCritical.length);
              core.setOutput('alerts', JSON.stringify(highCritical));
              
              console.log(`Found ${highCritical.length} HIGH/CRITICAL alerts`);
              
              return highCritical.length > 0;
            } catch (error) {
              console.log('Could not fetch alerts:', error.message);
              core.setOutput('has_alerts', false);
              return false;
            }

      - name: üì¶ Update Dependencies
        if: steps.check_alerts.outputs.has_alerts == 'true'
        id: update_deps
        run: |
          # Create a new branch
          BRANCH_NAME="copilot-autofix-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "‚úÖ Branch created: $BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: üîß Analyze and Fix Vulnerabilities
        if: steps.check_alerts.outputs.has_alerts == 'true'
        run: |
          echo "üîç Analyzing vulnerabilities..."
          
          # Parse alerts and extract package information
          ALERTS='${{ steps.check_alerts.outputs.alerts }}'
          echo "$ALERTS" | jq -r '.[] | "- \(.security_advisory.summary) (\(.security_advisory.severity))"' || echo "No specific alerts to display"
          
          echo "üìù Vulnerability fixes would be applied here"
          echo "For Gradle projects, consider using:"
          echo "  - Dependabot PRs"
          echo "  - gradle-versions-plugin"
          echo "  - OWASP dependency check"

      - name: üß™ Run Tests
        if: steps.check_alerts.outputs.has_alerts == 'true'
        id: test
        continue-on-error: true
        run: |
          ./gradlew clean test
          echo "test_result=$?" >> $GITHUB_OUTPUT

      - name: üíæ Commit and Push Changes
        if: steps.check_alerts.outputs.has_alerts == 'true'
        id: commit
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "fix: Update dependencies to fix HIGH/CRITICAL vulnerabilities
            
            Automated security fixes based on Dependabot alerts.
            Alert count: ${{ steps.check_alerts.outputs.alert_count }}"
            
            git push origin ${{ env.BRANCH_NAME }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No changes to commit"
          fi

      - name: üéØ Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const alerts = JSON.parse('${{ steps.check_alerts.outputs.alerts }}');
            const alertsList = alerts.map(a => 
              `- **${a.security_advisory.severity.toUpperCase()}**: ${a.security_advisory.summary}\n  Package: \`${a.security_vulnerability.package.name}\``
            ).join('\n');
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ü§ñ Fix HIGH/CRITICAL Security Vulnerabilities',
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## üõ°Ô∏è Automated Security Fixes
            
            This PR fixes **${{ steps.check_alerts.outputs.alert_count }}** HIGH/CRITICAL security vulnerabilities.
            
            ### üö® Vulnerabilities Fixed
            ${alertsList}
            
            ### üß™ Test Results
            ${process.env.test_result === '0' ? '‚úÖ All tests passed' : '‚ö†Ô∏è Some tests failed - manual review needed'}
            
            ### üìã Next Steps
            1. Review the dependency updates
            2. Check if any code changes are needed
            3. Merge if everything looks good
            
            ---
            ü§ñ _This PR was automatically generated by the Auto-Fix workflow_`
            });
            
            console.log(`‚úÖ Pull Request created: ${pr.data.html_url}`);

      - name: üìä Summary Report
        if: always()
        run: |
          echo "## ü§ñ Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Alerts Found**: ${{ steps.check_alerts.outputs.alert_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Made**: ${{ steps.commit.outputs.has_changes || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Result**: ${{ steps.test.outputs.test_result == '0' && '‚úÖ Passed' || '‚ö†Ô∏è Failed' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_alerts.outputs.has_alerts }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **No HIGH/CRITICAL vulnerabilities found!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ö†Ô∏è Report No Alerts
        if: steps.check_alerts.outputs.has_alerts != 'true'
        run: |
          echo "‚úÖ No HIGH/CRITICAL security alerts found"
          echo "Your dependencies are up to date!"

